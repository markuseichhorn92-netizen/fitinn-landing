<!-- BOOKING MODAL - Apple Style -->
<style>
    .bk-rate-card { border: 2px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .bk-rate-card:hover { border-color: rgba(221,155,67,0.4); background: rgba(221,155,67,0.05); }
    .bk-rate-card.selected { border-color: #DD9B43; background: rgba(221,155,67,0.1); }
    .bk-rate-card.recommended { border-color: rgba(221,155,67,0.5); }
    .bk-module-opt { border: 2px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.2s; }
    .bk-module-opt:hover { border-color: rgba(221,155,67,0.3); }
    .bk-module-opt.selected { border-color: #DD9B43; background: rgba(221,155,67,0.1); }
    .bk-summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .bk-summary-row:last-child { border-bottom: none; }
    .bk-spinner { width: 20px; height: 20px; border: 2px solid rgba(0,0,0,0.2); border-top-color: #000; border-radius: 50%; animation: bk-spin 0.6s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes bk-spin { to { transform: rotate(360deg); } }
    .bk-input { width: 100%; height: 52px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 0 16px; font-size: 16px; color: white; transition: border-color 0.2s; }
    .bk-input:focus { outline: none; border-color: #DD9B43; }
    .bk-input::placeholder { color: rgba(255,255,255,0.35); }
    .bk-form-step { display: none; }
    .bk-form-step.active { display: block; animation: bkFadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes bkFadeIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
</style>

<style>
    /* Prevent horizontal scroll */
    #modal-booking .modal-content { overflow-x: hidden; max-width: 100%; }
    
    /* Uniform input sizing - FIXED */
    #modal-booking input,
    #modal-booking select {
        width: 100%;
        height: 48px;
        max-height: 48px;
        min-height: 48px;
        padding: 0 16px;
        border-radius: 12px;
        box-sizing: border-box;
    }
    
    /* Dark styled select dropdown */
    #modal-booking select {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.15);
        color: white;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 40px;
    }
    #modal-booking select:focus {
        outline: none;
        border-color: #DD9B43;
    }
    #modal-booking select option {
        background: #2c2c2e;
        color: white;
        padding: 12px;
    }
    
    /* Dark styled checkboxes */
    #modal-booking input[type="checkbox"] {
        width: 22px;
        height: 22px;
        min-width: 22px;
        min-height: 22px;
        background: rgba(255,255,255,0.08);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 6px;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        position: relative;
        flex-shrink: 0;
    }
    #modal-booking input[type="checkbox"]:checked {
        background: #DD9B43;
        border-color: #DD9B43;
    }
    #modal-booking input[type="checkbox"]:checked::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #000;
        font-size: 14px;
        font-weight: bold;
    }
    #modal-booking input[type="checkbox"]:focus {
        outline: none;
        border-color: #DD9B43;
    }
    
    /* Date input fix - prevent oversized native picker */
    #modal-booking input[type="date"] {
        height: 48px;
        max-height: 48px;
        min-height: 48px;
        -webkit-appearance: none;
        appearance: none;
    }
    
    /* Mobile: all single column */
    @media (max-width: 640px) {
        #modal-booking .grid { 
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
        }
        #modal-booking .grid > * { 
            width: 100% !important;
            max-width: 100% !important;
        }
        #modal-booking .modal-content {
            padding-left: 16px;
            padding-right: 16px;
        }
    }
    .pb-safe-bk { padding-bottom: env(safe-area-inset-bottom, 20px); }
</style>
<div id="modal-booking" class="modal-overlay fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl">
    <div class="modal-content bg-[#1c1c1e] w-full overflow-y-auto border-t border-white/10 pb-safe-bk" style="max-width: 560px; margin-left: auto; margin-right: auto;">
        <!-- Handle (Mobile) -->
        <div class="modal-handle md:hidden" style="width:40px;height:5px;background:rgba(255,255,255,0.3);border-radius:3px;margin:12px auto;"></div>
        <!-- Header -->
        <div class="sticky top-0 bg-[#1c1c1e]/95 backdrop-blur-xl border-b border-white/10 px-6 py-4 flex justify-between items-center z-10">
            <div>
                <h2 class="text-xl font-bold">Mitgliedschaft</h2>
                <p class="text-sm text-white/50" id="bk-header-subtitle">W√§hle deinen Tarif</p>
            </div>
            <button onclick="closeModal('booking')" class="text-white/40 hover:text-white p-2 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Progress -->
        <div class="px-6 py-4 border-b border-white/10">
            <div class="flex justify-between text-xs text-white/40 mb-2">
                <span>Schritt <span id="bk-current-step">0</span> von 7</span>
                <span id="bk-step-name">Kontakt</span>
            </div>
            <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                <div id="bk-progress-bar" class="h-full bg-[#DD9B43] rounded-full transition-all" style="width: 14.28%"></div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="p-6">
            
            <!-- Step 0: Lead Capture - Premium Design -->
            <div id="bk-step-0" class="bk-form-step active">
                <!-- Hero Section -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#DD9B43] to-[#e6ac5a] rounded-2xl mb-4 shadow-lg shadow-[#DD9B43]/30">
                        <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">Angebot reservieren</h3>
                    <p class="text-white/60 text-sm">Sichere dir jetzt <span class="text-green-400 font-medium">unverbindlich</span> deinen Platz</p>
                </div>
                
                <!-- Form -->
                <div class="space-y-4">
                    <!-- Name Input with Icon -->
                    <div class="relative">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-white/40">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <input type="text" id="bk-lead-name" placeholder="Dein Name" 
                            class="w-full h-14 bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 text-white placeholder-white/40 focus:outline-none focus:border-[#DD9B43] focus:bg-white/10 transition-all">
                    </div>
                    
                    <!-- Email Input with Icon -->
                    <div class="relative">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-white/40">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <input type="email" id="bk-lead-email" placeholder="E-Mail Adresse" 
                            class="w-full h-14 bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 text-white placeholder-white/40 focus:outline-none focus:border-[#DD9B43] focus:bg-white/10 transition-all">
                    </div>
                    
                    <!-- Phone Input with Icon -->
                    <div class="relative">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-white/40">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <input type="tel" id="bk-lead-phone" placeholder="Handynummer" 
                            class="w-full h-14 bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 text-white placeholder-white/40 focus:outline-none focus:border-[#DD9B43] focus:bg-white/10 transition-all">
                    </div>
                </div>
                
                <!-- CTA Button -->
                <button type="button" id="bk-btn-0" onclick="bkCaptureLeadAndContinue()" 
                    class="w-full h-14 bg-gradient-to-r from-[#DD9B43] to-[#e6ac5a] hover:from-[#e6ac5a] hover:to-[#DD9B43] text-black font-bold rounded-2xl mt-6 transition-all duration-300 shadow-lg shadow-[#DD9B43]/25 hover:shadow-[#DD9B43]/40 hover:scale-[1.02] active:scale-[0.98]">
                    Jetzt reservieren ‚Üí
                </button>
                
                <!-- Trust Badges -->
                <div class="flex items-center justify-center gap-6 mt-6 text-white/40 text-xs">
                    <div class="flex items-center gap-1.5">
                        <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Unverbindlich</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Kostenlos</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>2 Min</span>
                    </div>
                </div>
                
                <!-- WhatsApp Notice -->
                <p class="text-center text-white/30 text-xs mt-4">
                    üì± Du erh√§ltst sofort eine Best√§tigung per WhatsApp
                </p>
                
                <!-- TEST MODE: Skip buttons (hidden in production) -->
                <div class="flex gap-2 mt-4 opacity-30 hover:opacity-100 transition-opacity">
                    <button type="button" onclick="bkGoToStep(1)" class="flex-1 text-white/40 text-xs hover:text-white py-2">
                        [Dev] Skip
                    </button>
                    <button type="button" onclick="bkShowDemoSuccess()" class="flex-1 text-white/40 text-xs hover:text-white py-2">
                        [Dev] Success
                    </button>
                </div>
            </div>
            
            <!-- Step 1: Tarif -->
            <div id="bk-step-1" class="bk-form-step">
                <div class="flex items-center gap-2 mb-4">
                    <span class="inline-block bg-green-500/20 text-green-400 text-xs font-bold px-3 py-1 rounded-full">FR√úHLINGSSTART</span>
                    <span class="text-xs text-white/40">Nur bis 31.03.2026</span>
                </div>
                <h3 class="text-lg font-semibold mb-6">Welche Laufzeit passt zu dir?</h3>
                
                <div class="space-y-4" id="bk-rates-container">
                    <!-- Fr√ºhlingsstart 52 Wochen -->
                    <div class="bk-rate-card rounded-2xl p-5" data-rate-id="1215992930" data-term-id="1215992950" data-price="0" data-price-after="12" data-term="52 Wochen" data-name="Fr√ºhlingsstart 52W">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-lg">52 Wochen</h4>
                                <p class="text-sm text-white/50">Erstlaufzeit 1 Jahr</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-green-400">0‚Ç¨</span>
                                <span class="text-white/50 text-sm">/Woche</span>
                            </div>
                        </div>
                        <!-- Preis√§nderung deutlich anzeigen -->
                        <div class="bg-white/5 border border-white/10 rounded-lg p-3 mt-2">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-green-400 font-medium">Jetzt bis 31.03.: 0‚Ç¨</span>
                                <span class="text-white/30">‚Üí</span>
                                <span class="text-white/70">Ab 01.04.: <strong>12‚Ç¨/Woche</strong></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fr√ºhlingsstart 104 Wochen - Empfohlen -->
                    <div class="bk-rate-card recommended rounded-2xl p-5 relative" data-rate-id="1215992930" data-term-id="1215992960" data-price="0" data-price-after="9" data-term="104 Wochen" data-name="Fr√ºhlingsstart 104W">
                        <div class="absolute -top-3 left-5 bg-[#DD9B43] text-black text-xs font-bold px-3 py-1 rounded-full">Empfohlen ¬∑ Bester Preis</div>
                        <div class="flex justify-between items-start pt-1 mb-3">
                            <div>
                                <h4 class="font-semibold text-lg text-[#DD9B43]">104 Wochen</h4>
                                <p class="text-sm text-white/50">Erstlaufzeit 2 Jahre</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-green-400">0‚Ç¨</span>
                                <span class="text-white/50 text-sm">/Woche</span>
                            </div>
                        </div>
                        <!-- Preis√§nderung deutlich anzeigen -->
                        <div class="bg-[#DD9B43]/10 border border-[#DD9B43]/30 rounded-lg p-3 mt-2">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-green-400 font-medium">Jetzt bis 31.03.: 0‚Ç¨</span>
                                <span class="text-white/30">‚Üí</span>
                                <span class="text-[#DD9B43]">Ab 01.04.: <strong>9‚Ç¨/Woche</strong></span>
                            </div>
                            <p class="text-xs text-white/40 mt-1">25% g√ºnstiger als 52 Wochen!</p>
                        </div>
                    </div>
                    
                    <!-- Fr√ºhlingsstart Sch√ºler/Studenten/Azubis -->
                    <div class="bk-rate-card rounded-2xl p-5" data-rate-id="1215992931" data-term-id="1215992990" data-price="0" data-price-after="9" data-term="52 Wochen" data-name="Fr√ºhlingsstart Sch√ºler/Student">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-lg">Sch√ºler / Studenten / Azubis</h4>
                                <p class="text-sm text-white/50">52 Wochen ¬∑ Mit Nachweis</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-green-400">0‚Ç¨</span>
                                <span class="text-white/50 text-sm">/Woche</span>
                            </div>
                        </div>
                        <!-- Preis√§nderung deutlich anzeigen -->
                        <div class="bg-white/5 border border-white/10 rounded-lg p-3 mt-2">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-green-400 font-medium">Jetzt bis 31.03.: 0‚Ç¨</span>
                                <span class="text-white/30">‚Üí</span>
                                <span class="text-white/70">Ab 01.04.: <strong>9‚Ç¨/Woche</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="bk-btn-1" disabled onclick="bkGoToStep(2)" class="w-full bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full mt-6 transition-all disabled:opacity-40 disabled:cursor-not-allowed">
                    Weiter
                </button>
            </div>
            
            <!-- Step 2: Module -->
            <div id="bk-step-2" class="bk-form-step">
                <h3 class="text-lg font-semibold mb-2">Upgrade dein Training</h3>
                <p class="text-sm text-white/50 mb-6">Optional:</p>
                
                <div id="bk-modules-container" class="space-y-3"></div>
                <div id="bk-no-modules" class="text-center py-10 text-white/50" style="display: none;">
                    <span class="text-4xl block mb-2">‚ú®</span>
                    <p>Alles inklusive in deinem Tarif!</p>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="bkGoToStep(1)" class="flex-1 py-4 rounded-full border border-white/20 font-semibold hover:border-white/40 transition-all">Zur√ºck</button>
                    <button id="bk-btn-2" onclick="bkGoToStep(3)" class="flex-1 bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full transition-all">Weiter</button>
                </div>
            </div>
            
            <!-- Step 3: Pers√∂nliche Daten -->
            <div id="bk-step-3" class="bk-form-step">
                <h3 class="text-lg font-semibold mb-6">Pers√∂nliche Angaben</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Vorname</label>
                            <input type="text" id="bk-firstname" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nachname</label>
                            <input type="text" id="bk-lastname" required class="bk-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">E-Mail</label>
                            <input type="email" id="bk-email" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Telefon</label>
                            <input type="tel" id="bk-phone" required class="bk-input" placeholder="+49...">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Geburtsdatum</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select id="bk-birth-day" required class="bk-input text-center">
                                <option value="">Tag</option>
                            </select>
                            <select id="bk-birth-month" required class="bk-input text-center">
                                <option value="">Monat</option>
                                <option value="01">Jan</option>
                                <option value="02">Feb</option>
                                <option value="03">M√§r</option>
                                <option value="04">Apr</option>
                                <option value="05">Mai</option>
                                <option value="06">Jun</option>
                                <option value="07">Jul</option>
                                <option value="08">Aug</option>
                                <option value="09">Sep</option>
                                <option value="10">Okt</option>
                                <option value="11">Nov</option>
                                <option value="12">Dez</option>
                            </select>
                            <select id="bk-birth-year" required class="bk-input text-center">
                                <option value="">Jahr</option>
                            </select>
                        </div>
                        <input type="hidden" id="bk-birthdate">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Anrede</label>
                        <select id="bk-gender" required class="bk-input">
                            <option value="">W√§hlen</option>
                            <option value="MALE">Herr</option>
                            <option value="FEMALE">Frau</option>
                            <option value="UNISEX">Divers</option>
                        </select>
                    </div>
                </div>
                
                <div id="bk-age-error" class="bg-red-500/20 border border-red-500/30 text-red-400 text-sm rounded-xl p-4 mt-4" style="display: none;">
                    Du musst mindestens 18 Jahre alt sein, um einen Vertrag abzuschlie√üen.
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="bkGoToStep(2)" class="flex-1 py-4 rounded-full border border-white/20 font-semibold hover:border-white/40 transition-all">Zur√ºck</button>
                    <button id="bk-btn-3" onclick="bkValidateAgeAndContinue()" class="flex-1 bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full transition-all">Weiter</button>
                </div>
            </div>
            
            <!-- Step 4: Adresse -->
            <div id="bk-step-4" class="bk-form-step">
                <h3 class="text-lg font-semibold mb-6">Adresse</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-2">Stra√üe</label>
                            <input type="text" id="bk-street" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nr.</label>
                            <input type="text" id="bk-housenumber" required class="bk-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">PLZ</label>
                            <input type="text" id="bk-zip" required class="bk-input" maxlength="5">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-2">Stadt</label>
                            <input type="text" id="bk-city" required class="bk-input">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="bkGoToStep(3)" class="flex-1 py-4 rounded-full border border-white/20 font-semibold hover:border-white/40 transition-all">Zur√ºck</button>
                    <button id="bk-btn-4" onclick="bkGoToStep(5)" class="flex-1 bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full transition-all">Weiter</button>
                </div>
            </div>
            
            <!-- Step 5: Bankdaten -->
            <div id="bk-step-5" class="bk-form-step">
                <h3 class="text-lg font-semibold mb-2">Zahlungsdaten</h3>
                <p class="text-sm text-white/50 mb-6">SEPA-Lastschrift alle 14 Tage</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Kontoinhaber</label>
                        <input type="text" id="bk-accountholder" required class="bk-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">IBAN</label>
                        <input type="text" id="bk-iban" required class="bk-input" placeholder="DE89 3704 0044 0532 0130 00">
                    </div>
                </div>
                
                <div class="bg-white/5 border border-white/10 rounded-xl p-4 mt-4 text-xs text-white/50">
                    üîí Deine Daten werden verschl√ºsselt √ºbertragen.
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="bkGoToStep(4)" class="flex-1 py-4 rounded-full border border-white/20 font-semibold hover:border-white/40 transition-all">Zur√ºck</button>
                    <button id="bk-btn-5" onclick="bkGoToStep(6)" class="flex-1 bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full transition-all">Weiter</button>
                </div>
            </div>
            
            <!-- Step 6: Zusammenfassung -->
            <div id="bk-step-6" class="bk-form-step">
                <h3 class="text-lg font-semibold mb-6">Zusammenfassung</h3>
                
                <div class="bg-white/5 rounded-2xl p-5 mb-4">
                    <div id="bk-summary-content"></div>
                </div>
                
                <div class="bg-[#DD9B43]/10 border border-[#DD9B43]/30 rounded-2xl p-5 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Erste Zahlung</span>
                        <span id="bk-first-payment" class="text-xl font-bold text-[#DD9B43]">39‚Ç¨</span>
                    </div>
                    <p class="text-xs text-white/50 mt-1">Startpaket einmalig</p>
                </div>
                
                <div class="space-y-3 mb-6">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="bk-agb" required class="mt-1 accent-[#DD9B43] w-5 h-5">
                        <span class="text-sm text-white/70">Ich akzeptiere die <a href="https://fit-inn-trier.de/agb" target="_blank" rel="noopener" class="text-[#DD9B43] hover:underline">AGB</a> und <a href="https://fit-inn-trier.de/datenschutz" target="_blank" rel="noopener" class="text-[#DD9B43] hover:underline">Datenschutzerkl√§rung</a>.</span>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="bk-sepa" required class="mt-1 accent-[#DD9B43] w-5 h-5">
                        <span class="text-sm text-white/70">Ich erm√§chtige FIT-INN, Zahlungen per SEPA-Lastschrift einzuziehen.</span>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="bk-widerruf" required class="mt-1 accent-[#DD9B43] w-5 h-5">
                        <span class="text-sm text-white/70">Ich habe die <a href="https://fit-inn-trier.de/widerruf" target="_blank" rel="noopener" class="text-[#DD9B43] hover:underline">Widerrufsbelehrung</a> gelesen.</span>
                    </label>
                </div>
                
                <div id="bk-form-error" class="bg-red-500/20 border border-red-500/30 text-red-400 text-sm rounded-xl p-4 mb-4" style="display: none;"></div>
                
                <div class="flex gap-3">
                    <button onclick="bkGoToStep(5)" class="flex-1 py-4 rounded-full border border-white/20 font-semibold hover:border-white/40 transition-all">Zur√ºck</button>
                    <button id="bk-submit-btn" onclick="bkSubmit()" class="flex-1 bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full transition-all">
                        Mitglied werden
                    </button>
                </div>
            </div>
            
            <!-- Step 7: Best√§tigung -->
            <div id="bk-step-7" class="bk-form-step">
                <div class="text-center py-4">
                    <!-- Success Animation -->
                    <div class="relative w-24 h-24 mx-auto mb-6">
                        <div class="absolute inset-0 bg-green-500/20 rounded-full animate-ping"></div>
                        <div class="relative w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <h3 class="text-2xl font-bold mb-2">Willkommen bei FIT-INN! üéâ</h3>
                    <p class="text-white/60 mb-6">Deine Mitgliedschaft wurde erfolgreich erstellt.</p>
                    
                    <!-- Contract Details Card -->
                    <div class="bg-gradient-to-br from-[#DD9B43]/20 to-[#DD9B43]/5 border border-[#DD9B43]/30 rounded-2xl p-5 text-left mb-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-[#DD9B43] rounded-full flex items-center justify-center">
                                <span class="text-black font-bold" id="bk-confirm-initials">ME</span>
                            </div>
                            <div>
                                <p class="font-semibold" id="bk-confirm-name">-</p>
                                <p class="text-sm text-white/50" id="bk-confirm-email">-</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-white/10">
                                <span class="text-white/50">Mitgliedsnummer</span>
                                <span class="font-mono font-bold text-[#DD9B43]" id="bk-confirm-member-nr">-</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-white/10">
                                <span class="text-white/50">Vertragsnummer</span>
                                <span class="font-mono" id="bk-confirm-contract">-</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-white/10">
                                <span class="text-white/50">Tarif</span>
                                <span id="bk-confirm-rate">-</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-white/10">
                                <span class="text-white/50">Startdatum</span>
                                <span id="bk-confirm-start">-</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-white/50">Status</span>
                                <span class="text-green-400 font-medium">‚úì Aktiv</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Next Steps -->
                    <div class="bg-white/5 rounded-2xl p-5 text-left mb-6">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            <span>üìã</span> N√§chste Schritte
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex gap-3">
                                <div class="w-6 h-6 bg-[#DD9B43]/20 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-[#DD9B43] text-xs font-bold">1</span>
                                </div>
                                <p class="text-white/70">Komm vorbei und hol dir deinen <strong class="text-white">Mitgliedsausweis</strong> an der Theke ab.</p>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-6 h-6 bg-[#DD9B43]/20 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-[#DD9B43] text-xs font-bold">2</span>
                                </div>
                                <p class="text-white/70">Lade die <strong class="text-white">MySports App</strong> herunter f√ºr Kursbuchungen & Check-in.</p>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-6 h-6 bg-[#DD9B43]/20 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-[#DD9B43] text-xs font-bold">3</span>
                                </div>
                                <p class="text-white/70">Buche dein kostenloses <strong class="text-white">Einweisungstraining</strong> mit einem Trainer.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation Email Notice -->
                    <p class="text-xs text-white/40 mb-6">
                        üìß Eine Best√§tigungsmail mit allen Details wurde an <span id="bk-confirm-email-2">deine E-Mail</span> gesendet.
                    </p>
                    
                    <button onclick="closeModal('booking')" class="w-full bg-[#DD9B43] hover:bg-[#e6ac5a] text-black font-semibold py-4 rounded-full transition-all">
                        Los geht's! üí™
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const BK_API = 'https://fit-inn-trier.api.magicline.com/connect/v1';
const BK_RECAPTCHA_KEY = '6Lf42WEsAAAAAJklBBd1adX2vCMeR6AnfQUE6Ve_'; // FIT-INN reCAPTCHA v3 key
const BK_STUDIO_ID = 1210005460;
const BK_LEADS_API = window.LEADS_API || 'https://srv1309486.hstgr.cloud/api/leads';
let bkCurrentStep = 0;
let bkSelectedRate = null;
let bkSelectedModules = [];
let bkLeadData = { name: null, email: null, phone: null };
const bkStepNames = { 0: 'Kontakt', 1: 'Tarif', 2: 'Upgrades', 3: 'Daten', 4: 'Adresse', 5: 'Zahlung', 6: 'Best√§tigen', 7: 'Fertig' };

// Check URL params for returning leads (from email link)
function bkCheckReturningLead() {
    const params = new URLSearchParams(window.location.search);
    const leadId = params.get('lead');
    const name = params.get('name');
    const email = params.get('email');
    
    if (leadId && name) {
        // Returning lead from email - skip Step 0
        bkLeadData = { 
            id: leadId,
            name: decodeURIComponent(name), 
            email: email ? decodeURIComponent(email) : null,
            phone: null,
            isReturning: true 
        };
        console.log('Returning lead detected:', bkLeadData);
        return true;
    }
    return false;
}

// Initialize on modal open - check for returning lead
const bkOriginalOpenModal = window.openModal;
window.openModal = function(type) {
    if (type === 'booking') {
        if (bkCheckReturningLead()) {
            // Skip to Step 1 for returning leads
            setTimeout(() => bkGoToStep(1), 100);
        }
    }
    if (bkOriginalOpenModal) bkOriginalOpenModal(type);
};

// Lead Capture Function for Booking
async function bkCaptureLeadAndContinue() {
    console.log('bkCaptureLeadAndContinue called');
    const name = document.getElementById('bk-lead-name')?.value?.trim() || '';
    const email = document.getElementById('bk-lead-email')?.value?.trim() || '';
    const phone = document.getElementById('bk-lead-phone')?.value?.trim() || '';
    console.log('Name:', name, 'Email:', email, 'Phone:', phone);
    
    // Validate: Name, Email AND Phone required
    if (!name) {
        alert('Bitte gib deinen Namen ein');
        return;
    }
    if (!email || !email.includes('@')) {
        alert('Bitte gib eine g√ºltige E-Mail-Adresse ein');
        return;
    }
    if (!phone || phone.length < 6) {
        alert('Bitte gib deine Handynummer ein');
        return;
    }
    
    bkLeadData = { name, email, phone };
    
    // Save lead to backend - sends WhatsApp (if phone) AND Email
    fetch(BK_LEADS_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            name, 
            email,
            phone: phone || null, 
            type: 'mitgliedschaft', 
            source: 'landing-page',
            sendConfirmation: true  // Trigger WhatsApp + Email
        })
    }).catch(e => console.error('Lead save error:', e));
    
    // Continue to next step immediately
    bkGoToStep(1);
}

document.querySelectorAll('.bk-rate-card').forEach(card => {
    card.onclick = () => {
        document.querySelectorAll('.bk-rate-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        bkSelectedRate = {
            rateId: parseInt(card.dataset.rateId),
            termId: parseInt(card.dataset.termId),
            price: parseFloat(card.dataset.price),
            priceAfter: parseFloat(card.dataset.priceAfter || card.dataset.price),
            term: card.dataset.term,
            name: card.dataset.name
        };
        document.getElementById('bk-btn-1').disabled = false;
    };
});

function bkGoToStep(n) {
    console.log('bkGoToStep called with:', n);
    bkCurrentStep = n;
    document.querySelectorAll('.bk-form-step').forEach(s => s.classList.remove('active'));
    const stepEl = document.getElementById(`bk-step-${n}`);
    console.log('Step element:', stepEl);
    if (stepEl) stepEl.classList.add('active');
    document.getElementById('bk-progress-bar').style.width = `${((n+1)/8)*100}%`;
    document.getElementById('bk-current-step').textContent = n;
    document.getElementById('bk-step-name').textContent = bkStepNames[n];
    const subtitles = { 0: 'Kurz kennenlernen', 1: 'W√§hle deinen Tarif', 2: 'Optionale Extras', 3: '√úber dich', 4: 'F√ºr den Vertrag', 5: 'SEPA-Lastschrift', 6: 'Pr√ºfen & Best√§tigen', 7: 'Willkommen!' };
    document.getElementById('bk-header-subtitle').textContent = subtitles[n] || '';
    if (n === 2) bkRenderModules();
    if (n === 6) bkRenderSummary();
    // Pre-fill from lead data
    if (n === 3 && bkLeadData.name) {
        const nameParts = bkLeadData.name.split(' ');
        if (!document.getElementById('bk-firstname').value) {
            document.getElementById('bk-firstname').value = nameParts[0] || '';
            document.getElementById('bk-lastname').value = nameParts.slice(1).join(' ') || '';
        }
        if (!document.getElementById('bk-email').value && bkLeadData.email) {
            document.getElementById('bk-email').value = bkLeadData.email;
        }
        if (!document.getElementById('bk-phone').value && bkLeadData.phone) {
            document.getElementById('bk-phone').value = bkLeadData.phone;
        }
    }
}

function bkRenderModules() {
    const container = document.getElementById('bk-modules-container');
    const noModules = document.getElementById('bk-no-modules');
    container.innerHTML = '';
    bkSelectedModules = [];
    
    // Fr√ºhlingsstart-Tarife haben keine optionalen Module
    const modulesByRate = {
        // Fr√ºhlingsstart 12M/24M - keine Module
        1215992930: [],
        // Fr√ºhlingsstart Sch√ºler/Studenten - keine Module
        1215992931: [],
        // Alte Tarife (falls noch ben√∂tigt)
        1213385750: [{ id: 1213385815, name: 'Ern√§hrungsplan 52 Wochen', price: 119, desc: 'Individuell f√ºr dich' }],
        1213385780: [
            { id: 1213878351, name: 'Activity Analyse', price: 39, desc: 'Bewegungsmuster-Check' },
            { id: 1213878352, name: 'Food & Stress Analyse', price: 19, desc: 'Ern√§hrung & Stress' },
            { id: 1213878353, name: 'Longevity Checkup', price: 49, desc: 'Langlebigkeitsanalyse' }
        ],
        1213385790: []
    };
    
    const modules = modulesByRate[bkSelectedRate.rateId] || [];
    if (!modules.length) { 
        container.style.display = 'none'; 
        noModules.style.display = 'block'; 
        // Update message for Fr√ºhlingsstart
        if (bkSelectedRate.rateId === 1215992930 || bkSelectedRate.rateId === 1215992931) {
            noModules.innerHTML = '<span class="text-4xl block mb-2">üå∏</span><p>Fr√ºhlingsstart-Aktion:<br>Alles inklusive!</p>';
        } else {
            noModules.innerHTML = '<span class="text-4xl block mb-2">‚ú®</span><p>Alles inklusive in deinem Tarif!</p>';
        }
    } else {
        container.style.display = 'block'; 
        noModules.style.display = 'none';
        modules.forEach(mod => {
            const div = document.createElement('div');
            div.className = 'bk-module-opt rounded-xl p-4 flex justify-between items-center';
            div.innerHTML = `<div><h4 class="font-medium">${mod.name}</h4><p class="text-xs text-white/50">${mod.desc}</p></div><div class="text-right"><span class="font-bold text-[#DD9B43]">+${mod.price}‚Ç¨</span></div>`;
            div.onclick = () => {
                div.classList.toggle('selected');
                if (div.classList.contains('selected')) bkSelectedModules.push(mod);
                else bkSelectedModules = bkSelectedModules.filter(m => m.id !== mod.id);
            };
            container.appendChild(div);
        });
    }
}

function bkRenderSummary() {
    const container = document.getElementById('bk-summary-content');
    const isFruehling = bkSelectedRate.price === 0;
    
    let html = `
        <div class="bk-summary-row"><span class="text-white/50">Tarif</span><span class="font-medium">${bkSelectedRate.name}</span></div>
        <div class="bk-summary-row"><span class="text-white/50">Laufzeit</span><span>${bkSelectedRate.term}</span></div>
    `;
    
    // Preisanzeige mit √Ñnderung
    if (isFruehling) {
        html += `
            <div class="bk-summary-row">
                <span class="text-white/50">Beitrag jetzt</span>
                <span class="text-green-400 font-medium">0‚Ç¨/Woche</span>
            </div>
            <div class="bk-summary-row">
                <span class="text-white/50">Ab 01.04.2026</span>
                <span class="font-medium">${bkSelectedRate.priceAfter}‚Ç¨/Woche</span>
            </div>
        `;
    } else {
        html += `<div class="bk-summary-row"><span class="text-white/50">Beitrag</span><span>${bkSelectedRate.price}‚Ç¨/Woche</span></div>`;
    }
    
    html += `<div class="bk-summary-row"><span class="text-white/50">Startpaket</span><span>39‚Ç¨</span></div>`;
    
    let total = 39;
    if (bkSelectedModules.length) {
        html += `<div class="border-t border-white/10 my-2"></div>`;
        bkSelectedModules.forEach(m => { html += `<div class="bk-summary-row"><span class="text-white/50">${m.name}</span><span>+${m.price}‚Ç¨</span></div>`; total += m.price; });
    }
    
    // Fr√ºhlingsstart Info-Box
    if (isFruehling) {
        html += `
            <div class="border-t border-white/10 my-3"></div>
            <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-xs">
                <p class="text-green-400 font-medium mb-1">üéâ Fr√ºhlingsstart-Aktion</p>
                <p class="text-white/60">Du trainierst bis 31.03.2026 komplett beitragsfrei. Ab 01.04.2026 zahlst du ${bkSelectedRate.priceAfter}‚Ç¨/Woche.</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
    document.getElementById('bk-first-payment').textContent = total + '‚Ç¨';
}

// Format phone number for Magicline API
function bkFormatPhone(phone) {
    let p = phone.replace(/[\s\-\/\(\)]/g, '');
    // Convert German formats to international E.164
    if (p.startsWith('00')) p = '+' + p.slice(2);
    else if (p.startsWith('0')) p = '+49' + p.slice(1);
    else if (!p.startsWith('+')) p = '+49' + p;
    // Ensure only digits after + (E.164 format)
    return '+' + p.slice(1).replace(/\D/g, '');
}

// Validate IBAN (basic check for German IBANs)
function bkValidateIBAN(iban) {
    const clean = iban.replace(/\s/g, '').toUpperCase();
    if (clean.length !== 22) return { valid: false, error: 'IBAN muss 22 Zeichen haben' };
    if (!clean.startsWith('DE')) return { valid: false, error: 'Nur deutsche IBANs (DE...) werden akzeptiert' };
    if (!/^DE\d{20}$/.test(clean)) return { valid: false, error: 'IBAN enth√§lt ung√ºltige Zeichen' };
    return { valid: true, iban: clean };
}

async function bkSubmit() {
    const btn = document.getElementById('bk-submit-btn');
    const errDiv = document.getElementById('bk-form-error');
    errDiv.style.display = 'none';
    
    // Checkbox validation
    if (!document.getElementById('bk-agb').checked || !document.getElementById('bk-sepa').checked || !document.getElementById('bk-widerruf').checked) {
        errDiv.textContent = 'Bitte alle Checkboxen best√§tigen.';
        errDiv.style.display = 'block';
        return;
    }
    
    // IBAN validation
    const ibanResult = bkValidateIBAN(document.getElementById('bk-iban').value);
    if (!ibanResult.valid) {
        errDiv.textContent = ibanResult.error;
        errDiv.style.display = 'block';
        return;
    }
    
    // Phone validation
    const rawPhone = document.getElementById('bk-phone').value.trim();
    if (rawPhone.length < 6) {
        errDiv.textContent = 'Bitte eine g√ºltige Telefonnummer eingeben.';
        errDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="bk-spinner"></span>Wird gesendet...';
    
    try {
        // Get reCAPTCHA token
        let recaptchaToken = '';
        if (typeof grecaptcha !== 'undefined' && BK_RECAPTCHA_KEY) {
            try {
                recaptchaToken = await grecaptcha.execute(BK_RECAPTCHA_KEY, { action: 'contract' });
            } catch (recaptchaErr) {
                console.warn('reCAPTCHA failed:', recaptchaErr);
            }
        }
        
        // Magicline expects nested structure: customer{} + contract{} + studioId
        const payload = {
            studioId: BK_STUDIO_ID,
            contract: {
                rateBundleTermId: bkSelectedRate.termId,
                optionalRateBundleTermModules: bkSelectedModules.map(m => ({ id: m.id })),
                startDate: new Date().toISOString().split('T')[0]
            },
            customer: {
                // Personal data (lowercase field names per API spec!)
                firstname: document.getElementById('bk-firstname').value.trim(),
                lastname: document.getElementById('bk-lastname').value.trim(),
                dateOfBirth: document.getElementById('bk-birthdate').value,
                gender: document.getElementById('bk-gender').value,
                email: document.getElementById('bk-email').value.trim().toLowerCase(),
                telephone_mobile: bkFormatPhone(rawPhone),
                // Address
                street: document.getElementById('bk-street').value.trim(),
                houseNumber: document.getElementById('bk-housenumber').value.trim(),
                zipCode: document.getElementById('bk-zip').value.trim(),
                city: document.getElementById('bk-city').value.trim(),
                countryCode: 'DE',
                // Bank account
                bankAccount: {
                    accountHolder: document.getElementById('bk-accountholder').value.trim(),
                    iban: ibanResult.iban
                },
                paymentChoice: 'DIRECT_DEBIT'
            }
        };
        
        // Debug: Check if fields exist
        console.log('DEBUG - Field values:');
        console.log('  firstname input:', document.getElementById('bk-firstname'));
        console.log('  firstname value:', document.getElementById('bk-firstname')?.value);
        console.log('  lastname value:', document.getElementById('bk-lastname')?.value);
        console.log('  birthdate value:', document.getElementById('bk-birthdate')?.value);
        console.log('FULL PAYLOAD:', JSON.stringify(payload, null, 2));
        console.log('reCAPTCHA token:', recaptchaToken ? 'present (' + recaptchaToken.substring(0,20) + '...)' : 'MISSING');
        
        // Magicline: POST /rate-bundle for new contracts (NOT /contracts - that's for cancellation!)
        const apiUrl = `${BK_API}/rate-bundle?recaptchaToken=${encodeURIComponent(recaptchaToken)}`;
        const res = await fetch(apiUrl, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
        });
        
        // Handle empty or HTML responses
        const contentType = res.headers.get('content-type') || '';
        let result;
        const responseText = await res.text();
        
        if (contentType.includes('application/json') && responseText) {
            result = JSON.parse(responseText);
        } else if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
            // HTML error response
            const match = responseText.match(/MESSAGE:<\/td><td>([^<]+)/i) || responseText.match(/<title>([^<]+)/i);
            throw new Error(match ? match[1] : 'Server-Fehler. Bitte sp√§ter erneut versuchen.');
        } else if (!responseText) {
            throw new Error('Keine Antwort vom Server. Bitte sp√§ter erneut versuchen.');
        } else {
            result = { message: responseText };
        }
        
        if (!res.ok) {
            console.error('Magicline API Error:', res.status, result);
            
            // Parse error message
            let errorMsg = '';
            const fullJson = JSON.stringify(result).toLowerCase();
            
            if (result.violations?.length > 0) {
                errorMsg = result.violations.map(v => v.message || v.field).join(', ');
            } else if (result.errors?.length > 0) {
                errorMsg = result.errors.map(e => e.message || e.detail || e).join(', ');
            } else {
                errorMsg = result.detail || result.message || result.error || 'Ein Fehler ist aufgetreten.';
            }
            
            // User-friendly messages
            if (fullJson.includes('recaptcha')) errorMsg = 'Sicherheits√ºberpr√ºfung fehlgeschlagen. Bitte Seite neu laden.';
            else if (fullJson.includes('pattern') || fullJson.includes('invalid')) {
                if (fullJson.includes('iban')) errorMsg = 'Die IBAN ist ung√ºltig.';
                else if (fullJson.includes('phone') || fullJson.includes('mobile')) errorMsg = 'Telefonnummer ung√ºltig. Format: 0176 12345678';
                else if (fullJson.includes('email')) errorMsg = 'Die E-Mail-Adresse ist ung√ºltig.';
                else if (fullJson.includes('zip')) errorMsg = 'Die PLZ ist ung√ºltig (5 Ziffern).';
                else errorMsg = 'Eingabefehler: ' + errorMsg;
            }
            throw new Error(errorMsg);
        }
        
        // Fill confirmation page with API response data
        const firstname = payload.customer.firstname;
        const lastname = payload.customer.lastname;
        const email = payload.customer.email;
        const initials = (firstname[0] + lastname[0]).toUpperCase();
        
        // Log full response for debugging
        console.log('Magicline Success Response:', JSON.stringify(result, null, 2));
        
        // Extract data from response (Magicline returns different fields)
        const memberNumber = result.memberNumber || result.customerId || result.member?.number || '-';
        const contractNumber = result.contractNumber || result.contractId || result.contract?.number || result.id || '-';
        const startDate = result.startDate || result.contract?.startDate || payload.contract.startDate;
        
        // Format start date
        let formattedStartDate = '-';
        if (startDate) {
            const d = new Date(startDate);
            formattedStartDate = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Fill the confirmation fields
        document.getElementById('bk-confirm-initials').textContent = initials;
        document.getElementById('bk-confirm-name').textContent = `${firstname} ${lastname}`;
        document.getElementById('bk-confirm-email').textContent = email;
        document.getElementById('bk-confirm-email-2').textContent = email;
        document.getElementById('bk-confirm-member-nr').textContent = memberNumber;
        document.getElementById('bk-confirm-contract').textContent = contractNumber;
        document.getElementById('bk-confirm-rate').textContent = bkSelectedRate.name;
        document.getElementById('bk-confirm-start').textContent = formattedStartDate;
        
        bkGoToStep(7);
    } catch (err) {
        errDiv.textContent = err.message;
        errDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Mitglied werden';
    }
}

document.getElementById('bk-iban')?.addEventListener('input', function(e) {
    let v = e.target.value.replace(/\s/g, '').toUpperCase();
    e.target.value = v.replace(/(.{4})/g, '$1 ').trim();
});

// Populate birthdate dropdowns
(function() {
    const daySelect = document.getElementById('bk-birth-day');
    const yearSelect = document.getElementById('bk-birth-year');
    if (daySelect) {
        for (let d = 1; d <= 31; d++) {
            daySelect.innerHTML += `<option value="${d}">${d}</option>`;
        }
    }
    if (yearSelect) {
        const currentYear = new Date().getFullYear();
        for (let y = currentYear - 16; y >= currentYear - 100; y--) {
            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
        }
    }
})();

// Combine birthdate dropdowns into hidden field
function updateBkBirthdate() {
    const day = document.getElementById('bk-birth-day').value.padStart(2, '0');
    const month = document.getElementById('bk-birth-month').value;
    const year = document.getElementById('bk-birth-year').value;
    if (day && month && year) {
        document.getElementById('bk-birthdate').value = `${year}-${month}-${day}`;
    }
}
document.getElementById('bk-birth-day')?.addEventListener('change', updateBkBirthdate);
document.getElementById('bk-birth-month')?.addEventListener('change', updateBkBirthdate);
document.getElementById('bk-birth-year')?.addEventListener('change', updateBkBirthdate);

// Age validation - must be 18+
function bkCalculateAge(birthDate) {
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age;
}

function bkValidateAgeAndContinue() {
    const birthdate = document.getElementById('bk-birthdate').value;
    const errorDiv = document.getElementById('bk-age-error');
    
    // Check if birthdate is filled
    if (!birthdate) {
        errorDiv.textContent = 'Bitte gib dein Geburtsdatum ein.';
        errorDiv.style.display = 'block';
        return;
    }
    
    const age = bkCalculateAge(birthdate);
    
    if (age < 18) {
        errorDiv.textContent = `Du musst mindestens 18 Jahre alt sein, um einen Vertrag abzuschlie√üen. (Aktuelles Alter: ${age} Jahre)`;
        errorDiv.style.display = 'block';
        return;
    }
    
    // Age OK - hide error and continue
    errorDiv.style.display = 'none';
    bkGoToStep(4);
}

// Demo function to preview success page
function bkShowDemoSuccess() {
    // Set demo rate
    bkSelectedRate = {
        rateId: 1215992930,
        termId: 1215992960,
        price: 0,
        priceAfter: 9,
        term: '104 Wochen',
        name: 'Fr√ºhlingsstart 104W'
    };
    
    // Demo data
    const firstname = 'Markus';
    const lastname = 'Eichhorn';
    const email = 'markuseichhorn92@icloud.com';
    const initials = 'ME';
    const memberNumber = 'M-123456';
    const contractNumber = 'V-2026-00001';
    const formattedStartDate = '05.02.2026';
    
    // Fill confirmation fields
    document.getElementById('bk-confirm-initials').textContent = initials;
    document.getElementById('bk-confirm-name').textContent = `${firstname} ${lastname}`;
    document.getElementById('bk-confirm-email').textContent = email;
    document.getElementById('bk-confirm-email-2').textContent = email;
    document.getElementById('bk-confirm-member-nr').textContent = memberNumber;
    document.getElementById('bk-confirm-contract').textContent = contractNumber;
    document.getElementById('bk-confirm-rate').textContent = bkSelectedRate.name;
    document.getElementById('bk-confirm-start').textContent = formattedStartDate;
    
    bkGoToStep(7);
}
</script>
