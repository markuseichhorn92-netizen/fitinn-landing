<!-- ============================================ -->
<!-- MODAL: MITGLIEDSCHAFT BUCHEN (CONNECT API) -->
<!-- ============================================ -->
<style>
    /* Booking Modal Styles */
    .bk-rate-card { border: 2px solid rgba(255,255,255,0.15); cursor: pointer; transition: all 0.3s; }
    .bk-rate-card:hover { border-color: rgba(221,155,67,0.5); background: rgba(221,155,67,0.1); }
    .bk-rate-card.selected { border-color: #DD9B43; background: rgba(221,155,67,0.2); }
    .bk-rate-card.recommended { border-color: #DD9B43; }
    .bk-module-opt { border: 2px solid rgba(255,255,255,0.15); cursor: pointer; transition: all 0.2s; }
    .bk-module-opt:hover { border-color: rgba(221,155,67,0.3); }
    .bk-module-opt.selected { border-color: #DD9B43; background: rgba(221,155,67,0.15); }
    .bk-summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .bk-summary-row:last-child { border-bottom: none; }
    .bk-spinner { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #DD9B43; border-radius: 50%; animation: bk-spin 0.8s linear infinite; }
    @keyframes bk-spin { to { transform: rotate(360deg); } }
    .bk-input { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px 12px; font-size: 0.875rem; color: white; transition: border-color 0.2s; }
    .bk-input:focus { outline: none; border-color: #DD9B43; }
    .bk-input::placeholder { color: rgba(255,255,255,0.4); }
    .bk-form-step { display: none; }
    .bk-form-step.active { display: block; animation: bkFadeIn 0.4s ease; }
    @keyframes bkFadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
</style>

<div id="modal-booking" class="modal-overlay fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
    <div class="modal-content bg-primary-dark rounded-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto border border-white/20 shadow-2xl">
        <!-- Header -->
        <div class="sticky top-0 bg-primary-dark border-b border-white/10 p-5 flex justify-between items-center z-10">
            <div>
                <h2 class="text-xl font-bold">Mitgliedschaft abschlie√üen</h2>
                <p class="text-sm text-white/60" id="bk-header-subtitle">W√§hle deinen Tarif</p>
            </div>
            <button onclick="closeModal('booking')" class="text-white/60 hover:text-white p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Promo -->
        <div class="bg-accent/20 border-b border-accent/30 px-5 py-2.5 text-center">
            <p class="text-sm text-accent font-semibold">üéÅ 2 Monate geschenkt bei Basic & Premium!</p>
        </div>
        
        <!-- Progress Bar -->
        <div class="px-5 py-4 border-b border-white/10">
            <div class="flex justify-between text-xs text-white/50 mb-2">
                <span>Schritt <span id="bk-current-step">1</span> von 6</span>
                <span id="bk-step-name">Tarif w√§hlen</span>
            </div>
            <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                <div id="bk-progress-bar" class="h-full bg-accent rounded-full transition-all duration-300" style="width: 16.66%"></div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="p-5">
            
            <!-- Step 1: Tarif w√§hlen -->
            <div id="bk-step-1" class="bk-form-step active">
                <h3 class="text-lg font-bold mb-4">Welche Mitgliedschaft passt zu dir?</h3>
                
                <div class="space-y-4" id="bk-rates-container">
                    <!-- FLEX -->
                    <div class="bk-rate-card rounded-xl p-5" data-rate-id="1213385750" data-term-id="1213385760" data-price="15" data-term="4 Wochen" data-name="Flex">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg">Flex</h4>
                                <p class="text-sm text-white/60">4 Wochen Erstlaufzeit</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold">15‚Ç¨</span>
                                <span class="text-white/60">/Woche</span>
                            </div>
                        </div>
                        <ul class="text-sm text-white/70 space-y-1">
                            <li>‚úì Maximale Flexibilit√§t</li>
                            <li>‚úì Komplette Club-Nutzung</li>
                            <li>‚úì Alle Ger√§te & Services</li>
                        </ul>
                        <p class="text-xs text-white/50 mt-3">+ 39‚Ç¨ Startpaket (einmalig)</p>
                    </div>
                    
                    <!-- BASIC -->
                    <div class="bk-rate-card rounded-xl p-5" data-rate-id="1213385780" data-term-id="1213385761" data-price="12" data-term="12 Monate" data-name="Basic">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg">Basic</h4>
                                <p class="text-sm text-white/60">52 Wochen Laufzeit</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold">12‚Ç¨</span>
                                <span class="text-white/60">/Woche</span>
                            </div>
                        </div>
                        <div class="bg-accent/20 text-accent text-xs font-semibold px-2 py-1 rounded inline-block mb-2">+ 2 Monate GRATIS</div>
                        <ul class="text-sm text-white/70 space-y-1">
                            <li>‚úì 20% Ersparnis vs. Flex</li>
                            <li>‚úì Komplette Club-Nutzung</li>
                            <li>‚úì Alle Ger√§te & Services</li>
                        </ul>
                        <p class="text-xs text-white/50 mt-3">+ 39‚Ç¨ Startpaket (einmalig)</p>
                    </div>
                    
                    <!-- PREMIUM -->
                    <div class="bk-rate-card recommended rounded-xl p-5 relative" data-rate-id="1213385790" data-term-id="1213385800" data-price="9" data-term="24 Monate" data-name="Premium">
                        <div class="absolute -top-3 left-4 bg-accent text-primary text-xs font-bold px-3 py-1 rounded-full">BESTE WAHL</div>
                        <div class="flex justify-between items-start mb-3 pt-2">
                            <div>
                                <h4 class="font-bold text-lg text-accent">Premium</h4>
                                <p class="text-sm text-white/60">104 Wochen Laufzeit</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-accent">9‚Ç¨</span>
                                <span class="text-white/60">/Woche</span>
                            </div>
                        </div>
                        <div class="bg-accent/20 text-accent text-xs font-semibold px-2 py-1 rounded inline-block mb-2">+ 2 Monate GRATIS + Check-up</div>
                        <ul class="text-sm text-white/70 space-y-1">
                            <li>‚úì 40% Ersparnis vs. Flex</li>
                            <li>‚úì Gesundheits-Check-up inkl.</li>
                            <li>‚úì Bestes Preis-Leistungs-Verh√§ltnis</li>
                        </ul>
                        <p class="text-xs text-white/50 mt-3">+ 39‚Ç¨ Startpaket (einmalig)</p>
                    </div>
                </div>
                
                <button id="bk-btn-1" disabled onclick="bkGoToStep(2)" class="w-full bg-accent hover:bg-accent-dark disabled:opacity-50 disabled:cursor-not-allowed text-primary font-bold py-3.5 rounded-lg mt-5 transition-all">
                    Weiter ‚Üí
                </button>
            </div>
            
            <!-- Step 2: Optionale Module (nur f√ºr Basic) -->
            <div id="bk-step-2" class="bk-form-step">
                <h3 class="text-lg font-bold mb-2">Upgrade dein Training</h3>
                <p class="text-sm text-white/60 mb-5">Optional ‚Äî verbessere deine Ergebnisse:</p>
                
                <div id="bk-modules-container" class="space-y-3">
                    <!-- Wird dynamisch bef√ºllt -->
                </div>
                
                <div id="bk-no-modules" class="text-center py-8 text-white/60" style="display: none;">
                    <p class="text-3xl mb-2">‚ú®</p>
                    <p>In deinem Tarif ist bereits alles enthalten!</p>
                </div>
                
                <div class="flex gap-3 mt-5">
                    <button type="button" onclick="bkGoToStep(1)" class="flex-1 border-2 border-white/20 hover:border-white/40 py-3 rounded-lg font-semibold transition-all">‚Üê Zur√ºck</button>
                    <button id="bk-btn-2" onclick="bkGoToStep(3)" class="flex-1 bg-accent hover:bg-accent-dark text-primary font-bold py-3 rounded-lg transition-all">Weiter ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 3: Pers√∂nliche Daten -->
            <div id="bk-step-3" class="bk-form-step">
                <h3 class="text-lg font-bold mb-4">Pers√∂nliche Angaben</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Vorname *</label>
                            <input type="text" id="bk-firstname" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Nachname *</label>
                            <input type="text" id="bk-lastname" required class="bk-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">E-Mail *</label>
                            <input type="email" id="bk-email" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Telefon *</label>
                            <input type="tel" id="bk-phone" required class="bk-input" placeholder="+49...">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Geburtsdatum *</label>
                            <input type="date" id="bk-birthdate" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Anrede *</label>
                            <select id="bk-gender" required class="bk-input">
                                <option value="">Bitte w√§hlen</option>
                                <option value="MALE">Herr</option>
                                <option value="FEMALE">Frau</option>
                                <option value="UNISEX">Divers</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-5">
                    <button type="button" onclick="bkGoToStep(2)" class="flex-1 border-2 border-white/20 hover:border-white/40 py-3 rounded-lg font-semibold transition-all">‚Üê Zur√ºck</button>
                    <button id="bk-btn-3" onclick="bkGoToStep(4)" class="flex-1 bg-accent hover:bg-accent-dark text-primary font-bold py-3 rounded-lg transition-all">Weiter ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 4: Adresse -->
            <div id="bk-step-4" class="bk-form-step">
                <h3 class="text-lg font-bold mb-4">Deine Adresse</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1.5">Stra√üe *</label>
                            <input type="text" id="bk-street" required class="bk-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Hausnr. *</label>
                            <input type="text" id="bk-housenumber" required class="bk-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">PLZ *</label>
                            <input type="text" id="bk-zip" required class="bk-input" maxlength="5">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1.5">Stadt *</label>
                            <input type="text" id="bk-city" required class="bk-input">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-5">
                    <button type="button" onclick="bkGoToStep(3)" class="flex-1 border-2 border-white/20 hover:border-white/40 py-3 rounded-lg font-semibold transition-all">‚Üê Zur√ºck</button>
                    <button id="bk-btn-4" onclick="bkGoToStep(5)" class="flex-1 bg-accent hover:bg-accent-dark text-primary font-bold py-3 rounded-lg transition-all">Weiter ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 5: Bankdaten (SEPA) -->
            <div id="bk-step-5" class="bk-form-step">
                <h3 class="text-lg font-bold mb-2">Zahlungsdaten</h3>
                <p class="text-sm text-white/60 mb-4">Abbuchung alle 14 Tage per SEPA-Lastschrift</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1.5">Kontoinhaber *</label>
                        <input type="text" id="bk-accountholder" required class="bk-input" placeholder="Wie auf der Karte/Konto">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1.5">IBAN *</label>
                        <input type="text" id="bk-iban" required class="bk-input" placeholder="DE89 3704 0044 0532 0130 00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1.5">BIC (optional)</label>
                        <input type="text" id="bk-bic" class="bk-input" placeholder="Wird automatisch ermittelt">
                    </div>
                </div>
                
                <div class="bg-white/5 border border-white/10 rounded-lg p-3 mt-4 text-xs text-white/60">
                    üîí <strong class="text-white/80">Sichere √úbertragung:</strong> Deine Bankdaten werden verschl√ºsselt an Magicline √ºbertragen und nicht auf unseren Servern gespeichert.
                </div>
                
                <div class="flex gap-3 mt-5">
                    <button type="button" onclick="bkGoToStep(4)" class="flex-1 border-2 border-white/20 hover:border-white/40 py-3 rounded-lg font-semibold transition-all">‚Üê Zur√ºck</button>
                    <button id="bk-btn-5" onclick="bkGoToStep(6)" class="flex-1 bg-accent hover:bg-accent-dark text-primary font-bold py-3 rounded-lg transition-all">Weiter ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 6: Zusammenfassung & AGB -->
            <div id="bk-step-6" class="bk-form-step">
                <h3 class="text-lg font-bold mb-4">Zusammenfassung</h3>
                
                <div class="bg-white/5 rounded-xl p-4 mb-4">
                    <h4 class="font-semibold mb-3 text-accent">Deine Mitgliedschaft</h4>
                    <div id="bk-summary-content">
                        <!-- Dynamisch bef√ºllt -->
                    </div>
                </div>
                
                <div class="bg-accent/10 border border-accent/30 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">Erste Zahlung (heute)</span>
                        <span id="bk-first-payment" class="text-xl font-bold text-accent">39‚Ç¨</span>
                    </div>
                    <p class="text-xs text-white/60 mt-1">Startpaket einmalig ‚Äî Beitr√§ge ab April</p>
                </div>
                
                <div class="space-y-3 mb-5">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="bk-agb" required class="mt-1 accent-accent">
                        <span class="text-sm text-white/80">
                            Ich akzeptiere die <a href="https://fit-inn-trier.de/agb" target="_blank" class="text-accent hover:underline">AGB</a> und <a href="https://fit-inn-trier.de/datenschutz" target="_blank" class="text-accent hover:underline">Datenschutzerkl√§rung</a>. *
                        </span>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="bk-sepa" required class="mt-1 accent-accent">
                        <span class="text-sm text-white/80">
                            Ich erm√§chtige FIT-INN GmbH, Zahlungen von meinem Konto mittels SEPA-Lastschrift einzuziehen. *
                        </span>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="bk-widerruf" required class="mt-1 accent-accent">
                        <span class="text-sm text-white/80">
                            Ich habe die <a href="https://fit-inn-trier.de/widerruf" target="_blank" class="text-accent hover:underline">Widerrufsbelehrung</a> gelesen und verstanden. *
                        </span>
                    </label>
                </div>
                
                <div id="bk-form-error" class="bg-red-500/20 border border-red-500/30 text-red-300 text-sm rounded-lg p-3 mb-4" style="display: none;"></div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="bkGoToStep(5)" class="flex-1 border-2 border-white/20 hover:border-white/40 py-3 rounded-lg font-semibold transition-all">‚Üê Zur√ºck</button>
                    <button id="bk-submit-btn" onclick="bkSubmit()" class="flex-1 bg-accent hover:bg-accent-dark text-primary font-bold py-3.5 rounded-lg transition-all">
                        Jetzt Mitglied werden
                    </button>
                </div>
            </div>
            
            <!-- Step 7: Best√§tigung -->
            <div id="bk-step-7" class="bk-form-step">
                <div class="text-center py-6">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h3 class="text-2xl font-bold mb-2 text-accent">Willkommen bei FIT-INN!</h3>
                    <p class="text-white/70 mb-6">Deine Mitgliedschaft wurde erfolgreich abgeschlossen.</p>
                    
                    <div class="bg-white/10 rounded-xl p-4 text-left text-sm mb-5">
                        <div class="bk-summary-row"><span class="text-white/60">üìã Tarif</span><span id="bk-confirm-rate" class="font-semibold">-</span></div>
                        <div class="bk-summary-row"><span class="text-white/60">üë§ Name</span><span id="bk-confirm-name" class="font-semibold">-</span></div>
                        <div class="bk-summary-row"><span class="text-white/60">üî¢ Vertragsnr.</span><span id="bk-confirm-contract" class="font-semibold text-accent">-</span></div>
                        <div class="bk-summary-row"><span class="text-white/60">üìÖ Start</span><span id="bk-confirm-start" class="font-semibold">-</span></div>
                    </div>
                    
                    <div class="bg-accent/20 border border-accent/30 rounded-xl p-4 mb-5 text-left">
                        <p class="text-accent font-semibold mb-2">üéØ N√§chste Schritte:</p>
                        <ul class="text-sm text-white/70 space-y-1">
                            <li>‚úì Du erh√§ltst eine Best√§tigungs-E-Mail</li>
                            <li>‚úì Komm vorbei f√ºr dein erstes Training</li>
                            <li>‚úì Februar & M√§rz = beitragsfrei! üéÅ</li>
                        </ul>
                    </div>
                    
                    <button onclick="closeModal('booking')" class="w-full bg-accent hover:bg-accent-dark text-primary font-bold py-3 rounded-lg transition-all">
                        Super, los geht's!
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============ BOOKING SYSTEM (MAGICLINE CONNECT API) ============
const BK_API = 'https://fit-inn-trier.api.magicline.com/connect/v1';
const BK_STUDIO_ID = 1210005460;

let bkCurrentStep = 1;
let bkSelectedRate = null;
let bkSelectedModules = [];

const bkStepNames = {
    1: 'Tarif w√§hlen',
    2: 'Upgrades',
    3: 'Pers√∂nliche Daten',
    4: 'Adresse',
    5: 'Zahlungsdaten',
    6: 'Zusammenfassung',
    7: 'Best√§tigung'
};

// Rate selection
document.querySelectorAll('.bk-rate-card').forEach(card => {
    card.onclick = () => {
        document.querySelectorAll('.bk-rate-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        bkSelectedRate = {
            rateId: parseInt(card.dataset.rateId),
            termId: parseInt(card.dataset.termId),
            price: parseFloat(card.dataset.price),
            term: card.dataset.term,
            name: card.dataset.name
        };
        document.getElementById('bk-btn-1').disabled = false;
    };
});

function bkGoToStep(n) {
    bkCurrentStep = n;
    
    // Update form steps
    document.querySelectorAll('.bk-form-step').forEach(s => s.classList.remove('active'));
    document.getElementById(`bk-step-${n}`).classList.add('active');
    
    // Update progress
    document.getElementById('bk-progress-bar').style.width = `${(n/7)*100}%`;
    document.getElementById('bk-current-step').textContent = n;
    document.getElementById('bk-step-name').textContent = bkStepNames[n];
    
    // Subtitle
    const subtitles = {
        1: 'W√§hle deinen Tarif',
        2: 'Optionale Upgrades',
        3: 'Erz√§hl uns von dir',
        4: 'F√ºr deinen Vertrag',
        5: 'SEPA-Lastschrift',
        6: 'Fast geschafft!',
        7: 'Willkommen!'
    };
    document.getElementById('bk-header-subtitle').textContent = subtitles[n] || '';
    
    // Step 2: Render modules based on selected rate
    if (n === 2) {
        bkRenderModules();
    }
    
    // Step 6: Render summary
    if (n === 6) {
        bkRenderSummary();
    }
}

function bkRenderModules() {
    const container = document.getElementById('bk-modules-container');
    const noModules = document.getElementById('bk-no-modules');
    container.innerHTML = '';
    bkSelectedModules = [];
    
    // Module data (from API)
    const modulesByRate = {
        1213385750: [ // Flex
            { id: 1213385815, name: '12 Monate Ern√§hrungsplan', price: 119, desc: 'Individueller Plan f√ºr deine Ziele' }
        ],
        1213385780: [ // Basic
            { id: 1213878351, name: 'Activity Analyse + Coaching', price: 39, desc: 'Analyse deiner Bewegungsmuster' },
            { id: 1213878352, name: 'Food & Stress Analyse', price: 19, desc: 'Ern√§hrung & Stress-Level Check' },
            { id: 1213878353, name: 'Longevity Checkup', price: 49, desc: 'Gesundheits-Langlebigkeitsanalyse' }
        ],
        1213385790: [] // Premium - alles inkl.
    };
    
    const modules = modulesByRate[bkSelectedRate.rateId] || [];
    
    if (modules.length === 0) {
        container.style.display = 'none';
        noModules.style.display = 'block';
    } else {
        container.style.display = 'block';
        noModules.style.display = 'none';
        
        modules.forEach(mod => {
            const div = document.createElement('div');
            div.className = 'bk-module-opt rounded-xl p-4 flex justify-between items-center';
            div.dataset.moduleId = mod.id;
            div.innerHTML = `
                <div>
                    <h4 class="font-semibold">${mod.name}</h4>
                    <p class="text-xs text-white/60">${mod.desc}</p>
                </div>
                <div class="text-right">
                    <span class="font-bold text-accent">+${mod.price}‚Ç¨</span>
                    <span class="text-xs text-white/50 block">einmalig</span>
                </div>
            `;
            div.onclick = () => {
                div.classList.toggle('selected');
                if (div.classList.contains('selected')) {
                    bkSelectedModules.push({ id: mod.id, name: mod.name, price: mod.price });
                } else {
                    bkSelectedModules = bkSelectedModules.filter(m => m.id !== mod.id);
                }
            };
            container.appendChild(div);
        });
    }
}

function bkRenderSummary() {
    const container = document.getElementById('bk-summary-content');
    let html = `
        <div class="bk-summary-row"><span class="text-white/60">Tarif</span><span class="font-semibold">${bkSelectedRate.name}</span></div>
        <div class="bk-summary-row"><span class="text-white/60">Laufzeit</span><span>${bkSelectedRate.term}</span></div>
        <div class="bk-summary-row"><span class="text-white/60">Beitrag</span><span>${bkSelectedRate.price}‚Ç¨ / Woche</span></div>
        <div class="bk-summary-row"><span class="text-white/60">Startpaket</span><span>39‚Ç¨ (einmalig)</span></div>
    `;
    
    let totalFirst = 39;
    
    if (bkSelectedModules.length > 0) {
        html += `<div class="border-t border-white/10 my-2"></div>`;
        bkSelectedModules.forEach(mod => {
            html += `<div class="bk-summary-row"><span class="text-white/60">${mod.name}</span><span>+${mod.price}‚Ç¨</span></div>`;
            totalFirst += mod.price;
        });
    }
    
    container.innerHTML = html;
    document.getElementById('bk-first-payment').textContent = totalFirst + '‚Ç¨';
}

async function bkSubmit() {
    const btn = document.getElementById('bk-submit-btn');
    const errDiv = document.getElementById('bk-form-error');
    errDiv.style.display = 'none';
    
    // Validate checkboxes
    if (!document.getElementById('bk-agb').checked || 
        !document.getElementById('bk-sepa').checked || 
        !document.getElementById('bk-widerruf').checked) {
        errDiv.textContent = '‚ùå Bitte alle Checkboxen best√§tigen';
        errDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="bk-spinner inline-block mr-2 align-middle"></span>Wird gesendet...';
    
    // Build payload for Magicline Connect API
    const payload = {
        studioId: BK_STUDIO_ID,
        termId: bkSelectedRate.termId,
        optionalModuleIds: bkSelectedModules.map(m => m.id),
        customer: {
            gender: document.getElementById('bk-gender').value,
            firstname: document.getElementById('bk-firstname').value,
            lastname: document.getElementById('bk-lastname').value,
            email: document.getElementById('bk-email').value,
            mobileNumber: document.getElementById('bk-phone').value,
            dateOfBirth: document.getElementById('bk-birthdate').value,
            address: {
                street: document.getElementById('bk-street').value,
                houseNumber: document.getElementById('bk-housenumber').value,
                zip: document.getElementById('bk-zip').value,
                city: document.getElementById('bk-city').value,
                countryCode: 'DE'
            }
        },
        bankAccount: {
            accountHolder: document.getElementById('bk-accountholder').value,
            iban: document.getElementById('bk-iban').value.replace(/\s/g, ''),
            bic: document.getElementById('bk-bic').value || undefined
        },
        consents: {
            termsAndConditions: true,
            privacyPolicy: true,
            sepaMandate: true
        }
    };
    
    try {
        const res = await fetch(`${BK_API}/contract`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await res.json();
        
        if (!res.ok) {
            throw new Error(result.message || result.error || 'Fehler beim Vertragsabschluss');
        }
        
        // Success!
        document.getElementById('bk-confirm-rate').textContent = bkSelectedRate.name;
        document.getElementById('bk-confirm-name').textContent = `${payload.customer.firstname} ${payload.customer.lastname}`;
        document.getElementById('bk-confirm-contract').textContent = result.contractNumber || result.id || '-';
        document.getElementById('bk-confirm-start').textContent = new Date().toLocaleDateString('de-DE');
        
        bkGoToStep(7);
        
    } catch (err) {
        errDiv.textContent = '‚ùå ' + err.message;
        errDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Jetzt Mitglied werden';
    }
}

// IBAN formatting
document.getElementById('bk-iban')?.addEventListener('input', function(e) {
    let val = e.target.value.replace(/\s/g, '').toUpperCase();
    val = val.replace(/(.{4})/g, '$1 ').trim();
    e.target.value = val;
});
</script>
